# =============================================================
# Spoolman Klipper Macros
# =============================================================
# These macros allow Klipper to communicate with Spoolman via
# Moonraker's remote method API.
#
# Add these to your printer.cfg, or save this file and include it:
#   [include spoolman_macros.cfg]
#
# Requires Moonraker to have the [spoolman] section configured:
#   [spoolman]
#   server: http://YOUR_SPOOLMAN_IP:7912
#   sync_rate: 5
# =============================================================

# SET_ACTIVE_SPOOL
# Called automatically by toolhead macros (T0-T3) when a toolchange occurs.
# Also called by the NFC middleware via Moonraker's gcode script API.
# Usage: SET_ACTIVE_SPOOL ID=1
[gcode_macro SET_ACTIVE_SPOOL]
description: Set the active spool in Spoolman via Moonraker
gcode:
  {% if params.ID is defined %}
    # Call Moonraker's remote method to update the active spool in Spoolman
    {action_call_remote_method("spoolman_set_active_spool", spool_id=params.ID|int)}
  {% endif %}

# CLEAR_ACTIVE_SPOOL
# Call this at the end of a print to clear the active spool tracking.
# Add to your END_PRINT macro: CLEAR_ACTIVE_SPOOL
[gcode_macro CLEAR_ACTIVE_SPOOL]
description: Clear the active spool in Spoolman
gcode:
  # Pass None to Moonraker to deactivate spool tracking
  {action_call_remote_method("spoolman_set_active_spool", spool_id=None)}
