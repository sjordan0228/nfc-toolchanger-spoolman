# =============================================================
# Toolhead Macros with Spoolman Support
# =============================================================
# Add variable_spool_id: None to each of your T0-T3 toolchange
# macros so Fluidd can display and assign spools per toolhead.
#
# When an NFC tag is scanned:
#   1. The middleware calls SET_GCODE_VARIABLE to update spool_id
#   2. When the toolhead is next activated, SET_ACTIVE_SPOOL is called
#   3. Fluidd shows the correct spool for each toolhead
#
# NOTE: This is an EXAMPLE â€” your actual toolchange macros may differ.
# Add variable_spool_id: None and the SET_ACTIVE_SPOOL call to your
# existing T0-T3 macros in your toolboard config files.
# =============================================================

# =============================================================
# Persistent Spool ID Restore Macro
# =============================================================
# This macro runs automatically 1 second after Klipper starts.
# It reads the last saved spool IDs from disk and restores them
# to each toolhead macro variable, so you don't have to rescan
# your spools after a reboot or power cut.
#
# Requires [save_variables] in printer.cfg pointing to:
#   filename: ~/printer_data/config/klipper-toolchanger/offset_save_file.cfg
#
# The middleware saves spool IDs to this file automatically
# every time an NFC scan occurs.
# =============================================================
[delayed_gcode RESTORE_SPOOL_IDS]
initial_duration: 1  # runs 1 second after Klipper starts
gcode:
  {% set svv = printer.save_variables.variables %}
  # Restore T0 spool ID if previously saved by middleware
  {% if svv.t0_spool_id is defined %}
    SET_GCODE_VARIABLE MACRO=T0 VARIABLE=spool_id VALUE={svv.t0_spool_id}
    SET_ACTIVE_SPOOL ID={svv.t0_spool_id}
  {% endif %}
  # Restore T1 spool ID if previously saved by middleware
  {% if svv.t1_spool_id is defined %}
    SET_GCODE_VARIABLE MACRO=T1 VARIABLE=spool_id VALUE={svv.t1_spool_id}
  {% endif %}
  # Restore T2 spool ID if previously saved by middleware
  {% if svv.t2_spool_id is defined %}
    SET_GCODE_VARIABLE MACRO=T2 VARIABLE=spool_id VALUE={svv.t2_spool_id}
  {% endif %}
  # Restore T3 spool ID if previously saved by middleware
  {% if svv.t3_spool_id is defined %}
    SET_GCODE_VARIABLE MACRO=T3 VARIABLE=spool_id VALUE={svv.t3_spool_id}
  {% endif %}

# =============================================================
# Toolhead Macros with Spoolman Support
# =============================================================

# T0 toolhead macro
# variable_spool_id is read by Fluidd to display per-toolhead spool assignment
[gcode_macro T0]
variable_color: ""
variable_tool_number: 0
variable_spool_id: None  # Set automatically by NFC scan via middleware
gcode:
  # Perform the toolchange
  _CHANGE_TOOL T={tool_number}
  # If a spool has been assigned to this toolhead via NFC scan,
  # notify Spoolman that this spool is now active for tracking
  {% if spool_id != None %}
    SET_ACTIVE_SPOOL ID={spool_id}
  {% endif %}

# T1 toolhead macro
[gcode_macro T1]
variable_color: ""
variable_tool_number: 1
variable_spool_id: None  # Set automatically by NFC scan via middleware
gcode:
  _CHANGE_TOOL T={tool_number}
  {% if spool_id != None %}
    SET_ACTIVE_SPOOL ID={spool_id}
  {% endif %}

# T2 toolhead macro
[gcode_macro T2]
variable_color: ""
variable_tool_number: 2
variable_spool_id: None  # Set automatically by NFC scan via middleware
gcode:
  _CHANGE_TOOL T={tool_number}
  {% if spool_id != None %}
    SET_ACTIVE_SPOOL ID={spool_id}
  {% endif %}

# T3 toolhead macro
[gcode_macro T3]
variable_color: ""
variable_tool_number: 3
variable_spool_id: None  # Set automatically by NFC scan via middleware
gcode:
  _CHANGE_TOOL T={tool_number}
  {% if spool_id != None %}
    SET_ACTIVE_SPOOL ID={spool_id}
  {% endif %}
