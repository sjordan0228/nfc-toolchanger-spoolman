# =============================================================
# ESPHome config for Toolhead T3 NFC Reader
# =============================================================
# Hardware: ESP32-S3 DevKitC-1 + PN532 NFC module (I2C mode)
#
# PN532 DIP Switch settings for I2C mode:
#   Switch 1: ON
#   Switch 2: OFF
#
# Wiring:
#   PN532 VCC  → ESP32-S3 3V3
#   PN532 GND  → ESP32-S3 GND
#   PN532 SDA  → ESP32-S3 GPIO1
#   PN532 SCL  → ESP32-S3 GPIO0
#
# When an NFC tag is scanned, the UID is published to the MQTT
# topic nfc/toolhead/T3 as JSON: {"uid": "XX-XX-XX", "toolhead": "T3"}
# The middleware script on the Pi subscribes to this topic and
# updates Spoolman/Moonraker accordingly.
# =============================================================

esphome:
  name: toolhead-t3
  friendly_name: Toolhead T3 NFC
  min_version: 2025.11.0
  name_add_mac_suffix: false

# ESP32-S3 board configuration
# Note: We use esp-idf framework as it compiles reliably on ESPHome 2026.x
esp32:
  variant: esp32s3
  framework:
    type: esp-idf

# Enable serial logging for debugging
logger:

# Enable Home Assistant API for OTA updates and device management
api:

# Enable over-the-air updates — after first USB flash, all updates are wireless
ota:
  - platform: esphome

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  # Static IP prevents OTA upload failures due to DHCP address changes
  manual_ip:
    static_ip: 192.168.X.X   # Set your desired static IP for this device
    gateway: 192.168.X.1      # Usually your router IP
    subnet: 255.255.255.0
  # Fallback hotspot — activates if WiFi connection fails
  # Connect to this and visit 192.168.4.1 to reconfigure WiFi
  ap:
    ssid: "Toolhead-T3 Fallback"
    password: "CHANGE_ME"

# Captive portal serves the WiFi config page when in fallback hotspot mode
captive_portal:

# MQTT — publishes NFC scan events to the broker running on Home Assistant
mqtt:
  broker: YOUR_HOME_ASSISTANT_IP   # e.g. 192.168.1.100
  username: !secret mqtt_username
  password: !secret mqtt_password

# I2C bus configuration for PN532 communication
# Slow frequency (10000 Hz) improves reliability with the PN532
i2c:
  sda: GPIO1
  scl: GPIO0
  frequency: 10000
  scan: true  # Logs detected I2C devices on boot — useful for debugging

# PN532 NFC reader configuration
pn532_i2c:
  id: pn532_board
  on_tag:
    # Triggered every time an NFC tag is brought near the reader
    then:
      # Log the tag UID to the serial console for debugging
      - logger.log:
          format: "Tag scanned on T3: %s"
          args: [x.c_str()]
      # Publish the UID and toolhead identifier to MQTT as JSON
      # The middleware script on the Pi will receive this and look up the spool
      - mqtt.publish:
          topic: "nfc/toolhead/T3"
          payload: !lambda |-
            return "{\"uid\": \"" + x + "\", \"toolhead\": \"T0\"}";
